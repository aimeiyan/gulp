$(function(){function e(e){var s=$(".jh-gallery-header li");s.click(function(){var r=$(this).attr("group-id"),n="";s.removeClass("active"),$(this).addClass("active"),console.log(e,"---data--");for(var o=0;o<e.length;o++)if(e[o].id===r)if(e[o].picArr.length){for(var d=0;d<e[o].picArr.length;d++)e[o].picArr[d].isCover?n+='<div class="jh-gallery-box jh-isCover">':n+='<div class="jh-gallery-box">',n+='<div class="jh-gallery-box-subwrp"><i class="jh-gallery-cover-icon"></i><i class="jh-gallery-edit-remove-icon"></i><div><img src="'+e[o].picArr[d].src+'" alt="" data-id="'+e[o].picArr[d].id+'"></div><div class="jh-gallery-title-text"><div><input type="text" readonly="readonly" value="'+e[o].picArr[d].picName+'"><i class="jh-gallery-edit-icon"></i></div></div></div></div>';$(".jh-gallery-gallerys").empty().append(n)}else $(".jh-gallery-gallerys").empty().append("<img class='jh-upload-null-pic' src='../images/jh-pic-upload-null.jpg'>");t(),i(),l(),a()}),s.eq(0).trigger("click")}function t(){$(".jh-gallery-edit-remove-icon").click(function(){var e=$(this).closest(".jh-gallery-box"),t=e.find("img").attr("data-id");e.hasClass("jh-isCover")?alert("请先设置一张图片为封面。"):$.ajax({url:"../data/staffView/json/tuku/delPic.json",data:{imgId:t},type:"post",success:function(t){"1"===t.success?e.remove():"0"===t.success&&alert("删除不成功，请重新操作。")}})})}function i(){$(".jh-gallery-cover-icon").click(function(){var e=$(this).closest(".jh-gallery-box"),t=e.find("img").attr("data-id");$.ajax({url:"../data/staffView/json/tuku/coverPic.json",data:{imgId:t},type:"post",success:function(t){"1"===t.success?(e.addClass("jh-isCover"),e.siblings().removeClass("jh-isCover")):"0"===t.success&&alert("删除不成功，请重新操作。")}})})}function l(){$(".jh-gallery-edit-icon").click(function(){$(this).prev("input").attr("readonly",!1).addClass("jh-editing").trigger("select")})}function a(){$(".jh-gallery-title-text input").click(function(){if("readonly"===$(this).attr("readonly"))return!1}),$(".jh-gallery-title-text input").change(function(){var e=$(this).closest(".jh-gallery-box").find("img").attr("data-id"),t=$(this).val();$(this).attr("readonly",!0).removeClass("jh-editing"),$.ajax({url:"../data/staffView/json/tuku/editTitle.json",data:{imgId:e,imgTitle:t},type:"post",success:function(e){"1"===e.success?alert("修改成功"):"0"===e.success&&alert("修改不成功，请重新操作。")}})}),$(".jh-gallery-title-text input").keydown(function(e){var t=$(this);13===e.keyCode&&t.trigger("blur")})}function s(e,t,i,l,a){var s=e.value.substring(e.value.lastIndexOf(".")+1).toLowerCase(),r=window.navigator.userAgent.toUpperCase();if(".jpg,.jpeg,.bmp,.gif,.png".indexOf(s)>-1){if($(".jh-gallery-gallerys").append(l),e.files)if(window.FileReader){var n=new FileReader;n.onload=function(e){document.getElementById(t).setAttribute("src",e.target.result)},n.readAsDataURL(e.files[0])}else r.indexOf("SAFARI")>-1&&alert("不支持Safari6.0以下浏览器的图片预览!");else if(r.indexOf("MSIE")>-1)if(r.indexOf("MSIE 6")>-1)document.getElementById(t).setAttribute("src",e.value);else{e.select(),r.indexOf("MSIE 9")>-1&&e.blur();var o=document.getElementById(i+"New");null==o&&((o=document.createElement("div")).setAttribute("id",i+"New"),o.style.width=document.getElementById(t).width+"px",o.style.height=document.getElementById(t).height+"px",o.style.border="solid 1px #d2e2e2"),o.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='scale',src='"+document.selection.createRange().text+"')";var d=document.getElementById(i);d.parentNode.insertBefore(o,d),d.style.display="none"}else r.indexOf("FIREFOX")>-1?parseFloat(r.toLowerCase().match(/firefox\/([\d.]+)/)[1])<7?document.getElementById(t).setAttribute("src",e.files[0].getAsDataURL()):document.getElementById(t).setAttribute("src",window.URL.createObjectURL(e.files[0])):document.getElementById(t).setAttribute("src",e.value);a()}else alert("仅支持.jpg,.jpeg,.bmp,.gif,.png为后缀名的文件!");return e.value}function r(e){$.ajax({type:"GET",url:"../data/staffView/json/tuku/progress.json",data:{},cache:!1,success:function(s){"100%"===s.progress?($(e).css({width:s.progress}),$(e).closest(".jh-gallery-box-loading").removeClass("jh-gallery-box-loading"),setTimeout(function(){$(e).parent().hide()},500),clearInterval(n),t(),i(),l(),a()):$(e).css({width:s.progress})}})}$.ajax({url:"../data/staffView/json/tuku/tukuData.json",data:{},type:"post",success:function(t){for(var i="",l=0;l<t.length;l++)i+='<li group-id="'+t[l].id+'">'+t[l].text+"（"+t[l].picCount+"）</li>";$(".jh-gallery-header ul").append(i),e(t)}});var n;!function(){$("#jh-gallery-upload-file").change(function(){var e=$(this),t=e.val().split("\\"),i=t[t.length-1],l=$(".jh-gallery-gallerys .jh-gallery-box").length,a=$(".jh-gallery-header li.active").attr("group-id");s(this,"imgHeadPhoto-"+l,"divPreview-"+l,'<div class="jh-gallery-box"><div class="jh-gallery-box-subwrp jh-gallery-box-loading"><i class="jh-gallery-cover-icon"></i><i class="jh-gallery-edit-remove-icon"></i><div id="divPreview-'+l+'"><img src="" alt="" id="imgHeadPhoto-'+l+'"></div><div class="jh-gallery-title-text"><div><input type="text" readonly="readonly" title="'+i+'" value="'+i+'"><i class="jh-gallery-edit-icon"></i></div><div class="jh-gallery-progress-bar"><div class="jh-gallery-progress" id="progress-'+l+'"></div></div></div></div></div>',function(){function t(e,t){n=setInterval(function(){r("#progress-"+l)},100)}function s(e,t){console.log(e,t)}var o={url:"../data/staffView/json/tuku/jibenxinxi",data:{imgName:i,groupId:a},beforeSubmit:t,success:s,resetForm:!0};e.parent().ajaxSubmit(o)})})}(),$(document).off("mouseenter"),$(document).off("mouseleave"),$(document).on("mouseenter",".jh-gallery-box-subwrp",function(){$(this).hasClass("jh-gallery-box-loading")||($(this).find(".jh-gallery-cover-icon").show(),$(this).find(".jh-gallery-edit-remove-icon").show(),$(this).find(".jh-gallery-edit-icon").show())}).on("mouseleave",".jh-gallery-box-subwrp",function(){$(this).parent().hasClass("jh-isCover")||$(this).find(".jh-gallery-cover-icon").hide(),$(this).find(".jh-gallery-edit-remove-icon").hide(),$(this).find(".jh-gallery-edit-icon").hide()})});